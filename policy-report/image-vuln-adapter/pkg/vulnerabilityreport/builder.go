package vulnerabilityreport

import (
	"fmt"
	"strings"

	policyreport "github.com/kubernetes-sigs/wg-policy-prototypes/policy-report/image-vuln-adapter/pkg/apis/wgpolicyk8s.io/v1alpha2"
	"github.com/kubernetes-sigs/wg-policy-prototypes/policy-report/image-vuln-adapter/pkg/apis/imgvulnsecurity/v1alpha1"
	"github.com/kubernetes-sigs/wg-policy-prototypes/policy-report/image-vuln-adapter/pkg/kube"
	"github.com/kubernetes-sigs/wg-policy-prototypes/policy-report/image-vuln-adapter/pkg/imgvuln"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/utils/pointer"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil"
)

func GetScanJobName(obj client.Object) string {
	return fmt.Sprintf("scan-vulnerabilityreport-%s", kube.ComputeHash(kube.Object{
		Kind:      kube.Kind(obj.GetObjectKind().GroupVersionKind().Kind),
		Namespace: obj.GetNamespace(),
		Name:      obj.GetName(),
	}))
}

type ReportBuilder struct {
	scheme    *runtime.Scheme
	owner     metav1.Object
	container string
	hash      string
	data      v1alpha1.VulnerabilityReportData
}

type ReportBuilderPolicy struct {
	scheme    *runtime.Scheme
	owner     metav1.Object
	container string
	hash      string
	data      policyreport.PolicyReport
}

func NewReportBuilder(scheme *runtime.Scheme) *ReportBuilder {
	return &ReportBuilder{
		scheme: scheme,
	}
}

func NewReportBuilderPolicy(scheme *runtime.Scheme) *ReportBuilderPolicy {
	return &ReportBuilderPolicy{
		scheme: scheme,
	}
}

func (b *ReportBuilder) Controller(owner metav1.Object) *ReportBuilder {
	b.owner = owner
	return b
}

func (b *ReportBuilderPolicy) ControllerPolicy(owner metav1.Object) *ReportBuilderPolicy {
	b.owner = owner
	return b
}

func (b *ReportBuilder) Container(name string) *ReportBuilder {
	b.container = name
	return b
}

func (b *ReportBuilderPolicy) ContainerPolicy(name string) *ReportBuilderPolicy {
	b.container = name
	return b
}

func (b *ReportBuilder) PodSpecHash(hash string) *ReportBuilder {
	b.hash = hash
	return b
}

func (b *ReportBuilderPolicy) PodSpecHashPolicy(hash string) *ReportBuilderPolicy {
	b.hash = hash
	return b
}

func (b *ReportBuilder) Data(data v1alpha1.VulnerabilityReportData) *ReportBuilder {
	b.data = data
	return b
}

func (b *ReportBuilderPolicy) DataPolicy(data policyreport.PolicyReport) *ReportBuilderPolicy {
	b.data = data
	return b
}

func (b *ReportBuilder) reportName() (string, error) {
	kind, err := kube.KindForObject(b.owner, b.scheme)
	if err != nil {
		return "", err
	}
	return fmt.Sprintf("%s-%s-%s", strings.ToLower(kind),
		b.owner.GetName(), b.container), nil
}

func (b *ReportBuilderPolicy) reportNamePolicy() (string, error) {
	kind, err := kube.KindForObject(b.owner, b.scheme)
	if err != nil {
		return "", err
	}
	return fmt.Sprintf("%s-%s-%s", strings.ToLower(kind),
		b.owner.GetName(), b.container), nil
}

func (b *ReportBuilder) Get() (v1alpha1.VulnerabilityReport, error) {
	kind, err := kube.KindForObject(b.owner, b.scheme)
	if err != nil {
		return v1alpha1.VulnerabilityReport{}, fmt.Errorf("getting kind for object: %w", err)
	}

	labels := map[string]string{
		imgvuln.LabelResourceKind:      kind,
		imgvuln.LabelResourceName:      b.owner.GetName(),
		imgvuln.LabelResourceNamespace: b.owner.GetNamespace(),
		imgvuln.LabelContainerName:     b.container,
	}

	if b.hash != "" {
		labels[imgvuln.LabelPodSpecHash] = b.hash
	}

	reportName, err := b.reportName()
	if err != nil {
		return v1alpha1.VulnerabilityReport{}, err
	}

	report := v1alpha1.VulnerabilityReport{
		ObjectMeta: metav1.ObjectMeta{
			Name:      reportName,
			Namespace: b.owner.GetNamespace(),
			Labels:    labels,
		},
		Report: b.data,
	}
	err = controllerutil.SetControllerReference(b.owner, &report, b.scheme)
	if err != nil {
		return v1alpha1.VulnerabilityReport{}, fmt.Errorf("setting controller reference: %w", err)
	}
	// The OwnerReferencesPermissionsEnforcement admission controller protects the
	// access to metadata.ownerReferences[x].blockOwnerDeletion of an object, so
	// that only users with "update" permission to the finalizers subresource of the
	// referenced owner can change it.
	// We set metadata.ownerReferences[x].blockOwnerDeletion to false so that
	// additional RBAC permissions are not required when the OwnerReferencesPermissionsEnforcement
	// is enabled.
	// See https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#ownerreferencespermissionenforcement
	report.OwnerReferences[0].BlockOwnerDeletion = pointer.BoolPtr(false)
	return report, nil
}

func (b *ReportBuilderPolicy) GetPolicy() (policyreport.PolicyReport, error) {
	kind, err := kube.KindForObject(b.owner, b.scheme)
	if err != nil {
		return policyreport.PolicyReport{}, fmt.Errorf("getting kind for object: %w", err)
	}

	labels := map[string]string{
		imgvuln.LabelResourceKind:      kind,
		imgvuln.LabelResourceName:      b.owner.GetName(),
		imgvuln.LabelResourceNamespace: b.owner.GetNamespace(),
		imgvuln.LabelContainerName:     b.container,
	}

	if b.hash != "" {
		labels[imgvuln.LabelPodSpecHash] = b.hash
	}

	reportName, err := b.reportNamePolicy()
	if err != nil {
		return policyreport.PolicyReport{}, err
	}

	var report policyreport.PolicyReport
	report = b.data

	ObM := metav1.ObjectMeta{
		Name:      reportName,
		Namespace: b.owner.GetNamespace(),
		Labels:    labels,
	}

	report.ObjectMeta = ObM

	err = controllerutil.SetControllerReference(b.owner, &report, b.scheme)
	if err != nil {
		return policyreport.PolicyReport{}, fmt.Errorf("setting controller reference: %w", err)
	}
	// The OwnerReferencesPermissionsEnforcement admission controller protects the
	// access to metadata.ownerReferences[x].blockOwnerDeletion of an object, so
	// that only users with "update" permission to the finalizers subresource of the
	// referenced owner can change it.
	// We set metadata.ownerReferences[x].blockOwnerDeletion to false so that
	// additional RBAC permissions are not required when the OwnerReferencesPermissionsEnforcement
	// is enabled.
	// See https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#ownerreferencespermissionenforcement
	report.OwnerReferences[0].BlockOwnerDeletion = pointer.BoolPtr(false)
	return report, nil
}

